from datetime import datetime, timezone
import json

import pytest
from cpr_sdk.exceptions import FetchError
from cpr_sdk.models.search import Document, Hit, Passage
from cpr_sdk.vespa import parse_vespa_response, split_document_id
from vespa.io import VespaResponse


@pytest.fixture
def valid_vespa_search_response():
    with open("tests/test_data/search_responses/search_response.json") as f:
        response_json = json.load(f)
        return VespaResponse(
            json=response_json, status_code=200, url="", operation_type=""
        )


@pytest.fixture
def empty_vespa_search_response():
    with open("tests/test_data/search_responses/empty_search_response.json") as f:
        response_json = json.load(f)
        return VespaResponse(
            json=response_json, status_code=200, url="", operation_type=""
        )


@pytest.fixture
def invalid_vespa_search_response():
    return VespaResponse(
        json={"this json": "is not valid"}, status_code=500, url="", operation_type=""
    )


@pytest.fixture
def valid_get_document_response():
    with open("tests/test_data/search_responses/get_document_response.json") as f:
        response_json = json.load(f)
        return response_json


@pytest.fixture
def valid_get_passage_response():
    with open("tests/test_data/search_responses/get_passage_response.json") as f:
        response_json = json.load(f)
        return response_json


def test_whether_a_valid_vespa_response_is_parsed(valid_vespa_search_response):
    assert parse_vespa_response(vespa_response=valid_vespa_search_response)


def test_whether_an_invalid_vespa_response_raises_a_valueerror(
    invalid_vespa_search_response,
):
    with pytest.raises(FetchError) as excinfo:
        parse_vespa_response(vespa_response=invalid_vespa_search_response)
    assert "Received status code 500" in str(excinfo.value)


def test_whether_continuation_token_is_returned_when_present(
    valid_vespa_search_response,
):
    response = parse_vespa_response(vespa_response=valid_vespa_search_response)
    assert response.continuation_token
    assert response.prev_continuation_token


def test_whether_valid_get_document_response_is_parsed(valid_get_document_response):
    assert Hit.from_vespa_response(valid_get_document_response)


def test_whether_valid_get_document_response_is_parsed_hit():
    path = "tests/test_data/search_responses/family_documents.json"
    with open(path) as f:
        response_json = json.load(f)

    assert Document(
        family_name="Addressing Climate Change Risks on Water Resources in Honduras: Increased Systemic Resilience and Reduced Vulnerability of the Urban Poor",
        family_description="The objective of the project is to increase resilience to climate change and water-related risks for the most vulnerable population in Honduras through pilot activities and an overarching intervention to mainstream climate change considerations into water sector policies. The specific project objectives included: Strengthen institutional structures to mainstream climate risks into water resources management, national planning; Assist in safeguarding water supplies of Tegucigalpa metro area against water scarcity and extreme climate events; Build capacity and outreach to enable all stakeholders to respond to long-term climate change impacts",
        family_source="AF",
        family_import_id="AF.family.009MHNWR.0",
        family_slug="addressing-climate-change-risks-on-water-resources-in-honduras-increased-systemic-resilience-and-reduced-vulnerability-of-the-urban-poor_df09",
        family_category="MCF",
        family_publication_ts=datetime(2010, 9, 17, 0, 0, tzinfo=timezone.utc),
        family_geography="HND",
        family_geographies=["HND"],
        document_import_id="AF.document.009MHNWR.n0007",
        document_slug="final-evaluation-report_8dec",
        document_languages=["English"],
        document_content_type="application/pdf",
        document_cdn_object="HND/2010/addressing-climate-change-risks-on-water-resources-in-honduras-increased-systemic-resilience-and-reduced-vulnerability-of-the-urban-poor_0996c52e8a82f6caf973962e8972797c.pdf",
        document_source_url="https://fifspubprd.azureedge.net/afdocuments/project/62/4399_AF_Honduras_Terminal%20eval%20report_May%2017.pdf",
        document_title="Final evaluation report",
        corpus_type_name="AF",
        corpus_import_id="MCF.corpus.AF.n0000",
        metadata=[
            {"name": "family.region", "value": "Latin America & Caribbean"},
            {"name": "family.sector", "value": "Water management"},
            {"name": "family.status", "value": "Project Completed"},
            {"name": "family.project_id", "value": "009MHNWR"},
            {
                "name": "family.project_url",
                "value": "https://www.adaptation-fund.org/project/addressing-climate-change-risks-on-water-resources-in-honduras-increased-systemic-resilience-and-reduced-vulnerability-of-the-urban-poor/",
            },
            {"name": "family.implementing_agency", "value": "UN Development Programme"},
            {"name": "family.project_value_fund_spend", "value": "5620300"},
            {"name": "family.project_value_co_financing", "value": "0"},
        ],
        relevance=0.0017429193899782135,
        rank_features=None,
        concept_counts={
            "Q765:trade sector": 2,
            "Q404:terrestrial risk": 14,
            "Q715:tax": 2,
            "Q684:indigenous people": 1,
            "Q676:marginalized ethnicity": 1,
            "Q1286:early warning system": 3,
            "Q1343:climate finance": 21,
            "Q788:fishing sector": 1,
            "Q1276:direct investment": 2,
            "Q856:healthcare sector": 4,
            "Q779:finance and insurance sector": 9,
            "Q762:energy supply sector": 1,
            "Q760:extractive sector": 6,
            "Q787:forestry sector": 4,
            "Q763:environmental management sector": 5,
            "Q1167:people with limited assets": 9,
            "Q973:slow onset event": 1,
            "Q701:people on the move": 1,
            "Q786:agriculture sector": 9,
            "Q764:construction sector": 6,
            "Q818:water management sector": 30,
            "Q1277:fees and charges": 1,
            "Q1362:climate fund": 21,
            "Q956:societal impact": 12,
            "Q769:information communication technology sector": 3,
            "Q1282:zoning and spatial planning": 11,
            "Q695:youth": 2,
            "Q704:women and minority genders": 14,
            "Q1281:codes and standards": 1,
            "Q775:public sector": 23,
            "Q374:extreme weather": 19,
            "Q774:education sector": 3,
            "Q986:geohazard": 4,
        },
    ) == Hit.from_vespa_response(response_json["root"]["children"][0])


def test_whether_valid_get_passage_response_is_parsed_hit():
    path = "tests/test_data/search_responses/document_passages.json"
    with open(path) as f:
        response_json = json.load(f)

    assert Passage(
        family_name=None,
        family_description=None,
        family_source=None,
        family_import_id=None,
        family_slug=None,
        family_category=None,
        family_publication_ts=None,
        family_geography=None,
        family_geographies=[],
        document_import_id=None,
        document_slug=None,
        document_languages=[],
        document_content_type=None,
        document_cdn_object=None,
        document_source_url=None,
        document_title=None,
        corpus_type_name=None,
        corpus_import_id=None,
        metadata=None,
        relevance=0.0017429193899782135,
        rank_features=None,
        text_block=":unselected: o Strong working and coordination relationships were built with central level institutions and local level communities and entities. The project allowed for a fairly direct relationship with institutions linked to the water resource management sector, with producers, cooperators, Water Boards, Board of Trustees, City Halls, the academic sector and the National Drought Expert Committee. Nonetheless, evidence on the full and active participation of the private sector was missing.",
        text_block_id="1020",
        text_block_type="BlockType.TEXT",
        text_block_page=53,
        text_block_coords=[
            (125.9207992553711, 156.04559326171875),
            (540.864013671875, 156.39120483398438),
            (540.7703857421875, 269.5032043457031),
            (125.82720184326172, 269.1575927734375),
        ],
        concepts=[
            Passage.Concept(
                id="Q374",
                name="extreme weather",
                parent_concepts=[{"name": "", "id": "Q975"}],
                parent_concept_ids_flat="Q975,",
                model='KeywordClassifier("extreme weather")',
                end=383,
                start=376,
                timestamp=datetime(2025, 6, 5, 13, 27, 48, 345804),
            ),
            Passage.Concept(
                id="Q774",
                name="education sector",
                parent_concepts=[{"name": "", "id": "Q709"}],
                parent_concept_ids_flat="Q709,",
                model='KeywordClassifier("education sector")',
                end=358,
                start=343,
                timestamp=datetime(2025, 6, 5, 14, 54, 27, 687991),
            ),
            Passage.Concept(
                id="Q775",
                name="public sector",
                parent_concepts=[{"name": "", "id": "Q709"}],
                parent_concept_ids_flat="Q709,",
                model='KeywordClassifier("public sector")',
                end=256,
                start=231,
                timestamp=datetime(2025, 6, 5, 14, 58, 4, 387175),
            ),
            Passage.Concept(
                id="Q818",
                name="water management sector",
                parent_concepts=[{"name": "", "id": "Q709"}],
                parent_concept_ids_flat="Q709,",
                model='KeywordClassifier("water management sector")',
                end=256,
                start=231,
                timestamp=datetime(2025, 6, 5, 15, 45, 24, 608990),
            ),
        ],
    ) == Hit.from_vespa_response(response_json["root"]["children"][0])


def test_whether_valid_get_passage_response_is_parsed(valid_get_passage_response):
    assert Hit.from_vespa_response(valid_get_passage_response)


def test_whether_valid_document_id_is_correctly_split():
    namespace, schema, data_id = split_document_id(
        "id:doc_search:family_document::CCLW.family.11171.0"
    )
    assert namespace == "doc_search"
    assert schema == "family_document"
    assert data_id == "CCLW.family.11171.0"


def test_whether_invalid_document_id_raises_value_error():
    with pytest.raises(ValueError):
        split_document_id("this is not a valid document id")


def test_whether_empty_response_is_parsed_correctly(empty_vespa_search_response):
    response = parse_vespa_response(vespa_response=empty_vespa_search_response)
    assert response.total_hits == 0
    assert response.families == []
    assert response.continuation_token is None


def test_document_passage_parse_from_valid_response():
    response_hit = {
        "id": "id:doc_search:document_passage::CCLW.executive.10014.4470.1457",
        "fields": {
            "text_block_id": "1457",
            "search_weights_ref": "id:doc_search:search_weights::default_weights",
            "text_block_page": 83,
            "text_block_type": "BlockType.TABLE_CELL",
            "text_block_coords": [
                [529.1136, 261.1368],
                [613.6128, 261.1368],
                [613.6128, 356.8968],
                [529.1136, 356.8968],
            ],
            "text_embedding": {
                "type": "tensor<float>(x[768])",
                "values": [
                    0.20789211988449097,
                    0.1855461150407791,
                    0.2982337474822998,
                    0.11529706418514252,
                    0.33459505438804626,
                    0.7362281084060669,
                    0.19544661045074463,
                    -0.2315257042646408,
                    0.23124529421329498,
                    -0.13045354187488556,
                    -0.3318285644054413,
                    -0.2601591646671295,
                    -0.3327048420906067,
                    0.5218207240104675,
                    0.15327325463294983,
                    0.7341592907905579,
                    -0.008793744258582592,
                    -0.2441023737192154,
                    -0.05427415668964386,
                    0.09291082620620728,
                    0.25568699836730957,
                    -0.1256849616765976,
                    0.2842031419277191,
                    0.6100031137466431,
                    0.12120553106069565,
                    0.20135100185871124,
                    0.23899628221988678,
                    -0.03619140759110451,
                    -0.1619911640882492,
                    0.08358626067638397,
                    -0.2280353307723999,
                    -0.061750493943691254,
                    0.10557326674461365,
                    -0.20766815543174744,
                    0.20610962808132172,
                    0.22813084721565247,
                    -0.2696046233177185,
                    0.07275883108377457,
                    -0.24813684821128845,
                    -0.26605454087257385,
                    -0.49323442578315735,
                    -0.17297551035881042,
                    -0.0240209698677063,
                    -0.018689686432480812,
                    0.08833861351013184,
                    0.2625334858894348,
                    0.041872911155223846,
                    0.25631192326545715,
                    0.09491899609565735,
                    0.008804958313703537,
                    -0.25951558351516724,
                    -0.31544366478919983,
                    -0.06743458658456802,
                    0.24028638005256653,
                    -0.040986280888319016,
                    0.2541653513908386,
                    -0.04788714274764061,
                    -0.3079417645931244,
                    0.008409298025071621,
                    -0.17404837906360626,
                    0.3489213287830353,
                    -0.2894519865512848,
                    0.004576461855322123,
                    0.05681492015719414,
                    0.13125933706760406,
                    0.06568517535924911,
                    -0.3203679919242859,
                    0.3819257616996765,
                    0.21180754899978638,
                    -0.4287411570549011,
                    -0.028859928250312805,
                    0.4935489892959595,
                    0.36932042241096497,
                    -0.031947243958711624,
                    0.13672028481960297,
                    -0.1677727848291397,
                    -0.5412377715110779,
                    0.1566331833600998,
                    -0.3683249354362488,
                    -0.2017708271741867,
                    -0.13002008199691772,
                    -0.17427527904510498,
                    0.2537277340888977,
                    -0.3381236791610718,
                    0.37906336784362793,
                    -0.1648632287979126,
                    0.2850443720817566,
                    -0.10098560154438019,
                    -0.2127322405576706,
                    -0.1077439934015274,
                    0.17166690528392792,
                    -0.09656944125890732,
                    0.07951252907514572,
                    -0.12193157523870468,
                    -0.3214820921421051,
                    0.3047024607658386,
                    0.0483819916844368,
                    -0.058145202696323395,
                    0.11523595452308655,
                    0.07991410791873932,
                    -0.24587872624397278,
                    0.17598658800125122,
                    0.386591374874115,
                    -0.09123938530683517,
                    0.0527215376496315,
                    0.005353197455406189,
                    -0.11021819710731506,
                    0.23952649533748627,
                    0.07452414184808731,
                    0.3848381042480469,
                    -0.03277092054486275,
                    0.27156728506088257,
                    -0.18077294528484344,
                    -0.298725426197052,
                    0.00808336678892374,
                    0.19082443416118622,
                    0.2171994000673294,
                    0.18105386197566986,
                    0.4327382445335388,
                    0.15622667968273163,
                    -0.08946116268634796,
                    -0.2454867660999298,
                    0.026449456810951233,
                    0.20340824127197266,
                    -0.03773662820458412,
                    -0.3460998237133026,
                    0.27184176445007324,
                    0.07404068112373352,
                    -0.24482294917106628,
                    0.1340004950761795,
                    -0.07105018943548203,
                    -0.3674122989177704,
                    0.13226217031478882,
                    0.21985645592212677,
                    -0.23368513584136963,
                    -0.15564607083797455,
                    0.22677981853485107,
                    -0.10320776700973511,
                    0.029276076704263687,
                    -0.3777501583099365,
                    -0.25035014748573303,
                    0.2740112245082855,
                    0.043308064341545105,
                    0.060083527117967606,
                    0.32321831583976746,
                    0.13488087058067322,
                    0.08313725888729095,
                    -0.341362327337265,
                    -0.018483294174075127,
                    0.1808115541934967,
                    -0.06280529499053955,
                    -0.13260914385318756,
                    -0.003913286607712507,
                    -0.08358389139175415,
                    -0.4893054962158203,
                    0.3684214651584625,
                    -0.16374196112155914,
                    0.35371866822242737,
                    0.06353743374347687,
                    0.22693303227424622,
                    0.18281157314777374,
                    0.16317643225193024,
                    0.1497865915298462,
                    0.2575501799583435,
                    0.10619688034057617,
                    -0.023663675412535667,
                    0.3532581329345703,
                    0.15394610166549683,
                    -0.6383762955665588,
                    -0.10575960576534271,
                    -0.2721092998981476,
                    -0.32173803448677063,
                    0.08077751845121384,
                    -0.038436517119407654,
                    -0.09287343919277191,
                    0.3355511724948883,
                    0.1712871938943863,
                    -0.0931323692202568,
                    -0.49213674664497375,
                    -0.0033876707311719656,
                    -1.4625126123428345,
                    0.067155621945858,
                    -0.1170138344168663,
                    0.49826130270957947,
                    -0.07099086046218872,
                    -0.29319512844085693,
                    0.5437203645706177,
                    -0.04799700900912285,
                    0.4802674651145935,
                    0.07938165962696075,
                    0.08942503482103348,
                    -0.2827451527118683,
                    0.12150867283344269,
                    0.005851144902408123,
                    -0.040871381759643555,
                    -0.1036839634180069,
                    -0.21585296094417572,
                    0.13255320489406586,
                    0.16521406173706055,
                    -0.04145529866218567,
                    -0.20740057528018951,
                    0.4143501818180084,
                    0.12058655917644501,
                    0.0769663006067276,
                    0.35060915350914,
                    -0.0367635041475296,
                    -0.16921167075634003,
                    -0.1413901448249817,
                    0.5199213027954102,
                    -0.10691827535629272,
                    -0.06525854021310806,
                    -0.05968795344233513,
                    0.09901391714811325,
                    0.4633181095123291,
                    -0.04276198521256447,
                    -0.15412069857120514,
                    0.2637507915496826,
                    -0.015568118542432785,
                    0.26260679960250854,
                    -0.3859604001045227,
                    -0.08815526962280273,
                    0.40285491943359375,
                    -0.05849478766322136,
                    0.30688998103141785,
                    -0.13442760705947876,
                    0.9811644554138184,
                    0.38757455348968506,
                    -0.20078448951244354,
                    0.2527764141559601,
                    -0.2832011282444,
                    -0.21313996613025665,
                    -0.3112374544143677,
                    0.1614004373550415,
                    -0.14761093258857727,
                    0.5283758044242859,
                    0.2570157051086426,
                    -0.04379997402429581,
                    -0.2445656657218933,
                    0.4461035430431366,
                    -0.2963525354862213,
                    0.15707384049892426,
                    -0.3003222942352295,
                    0.3503829538822174,
                    -0.2814236581325531,
                    0.13315120339393616,
                    0.15094801783561707,
                    0.18930721282958984,
                    0.257162481546402,
                    0.1010291576385498,
                    -0.1564103364944458,
                    -0.316287636756897,
                    0.7383703589439392,
                    0.0053787692449986935,
                    0.292324960231781,
                    -0.17672918736934662,
                    -0.35278740525245667,
                    -0.10126771777868271,
                    -0.5281514525413513,
                    0.21350504457950592,
                    -0.25193366408348083,
                    0.04314051941037178,
                    0.10189232975244522,
                    0.13375496864318848,
                    0.11418323963880539,
                    0.1729748398065567,
                    -0.10669341683387756,
                    0.2708832621574402,
                    0.08859328925609589,
                    -0.0050459145568311214,
                    -0.11327305436134338,
                    0.05648496747016907,
                    0.13019110262393951,
                    -0.3759763836860657,
                    -0.1683434396982193,
                    -0.36821410059928894,
                    -0.06634576618671417,
                    0.5113952159881592,
                    0.2380215972661972,
                    0.19305725395679474,
                    -0.28414756059646606,
                    -0.20682093501091003,
                    -0.3865647315979004,
                    0.06465096026659012,
                    -0.4298897683620453,
                    -0.0904305949807167,
                    0.06692663580179214,
                    -0.16457319259643555,
                    -0.29917311668395996,
                    -0.15654194355010986,
                    0.3283032476902008,
                    0.06317400932312012,
                    0.16668805480003357,
                    -0.20002107322216034,
                    -0.25213873386383057,
                    -0.00020507644512690604,
                    -0.3219473361968994,
                    -0.3014777600765228,
                    -0.24927666783332825,
                    0.23776718974113464,
                    -0.17772890627384186,
                    -0.4831737279891968,
                    0.08463054150342941,
                    -0.5901039242744446,
                    0.39958804845809937,
                    -0.2803567945957184,
                    -0.42726361751556396,
                    0.14736855030059814,
                    0.117891825735569,
                    -6.415086269378662,
                    0.2544141709804535,
                    -0.31324487924575806,
                    0.15372836589813232,
                    0.26668933033943176,
                    0.1434657722711563,
                    0.08307462930679321,
                    0.20722855627536774,
                    -0.2317080795764923,
                    -0.32741788029670715,
                    0.33697474002838135,
                    -0.34201231598854065,
                    -0.01902162656188011,
                    -0.09257326275110245,
                    0.13659407198429108,
                    0.06413841992616653,
                    0.27852189540863037,
                    -0.20331287384033203,
                    -0.4723435044288635,
                    -0.1504366546869278,
                    0.0686381459236145,
                    -0.4301380217075348,
                    0.5920576453208923,
                    0.028568236157298088,
                    0.26408812403678894,
                    0.015920942649245262,
                    -0.12913234531879425,
                    0.03874480351805687,
                    -0.13730372488498688,
                    -0.3590422570705414,
                    0.33586928248405457,
                    -0.3711680471897125,
                    -0.06645508110523224,
                    0.4847920536994934,
                    0.09773188829421997,
                    0.15254813432693481,
                    0.10492049157619476,
                    -0.36073076725006104,
                    -0.31722256541252136,
                    -0.22126153111457825,
                    0.11166711896657944,
                    -0.2896214723587036,
                    0.1480175107717514,
                    -0.007069569546729326,
                    0.1037614569067955,
                    -0.3187992572784424,
                    -0.2302447408437729,
                    0.12222626060247421,
                    -0.21165646612644196,
                    -0.09168632328510284,
                    0.33306920528411865,
                    0.3411642014980316,
                    -0.02052568830549717,
                    -0.29954880475997925,
                    0.18349617719650269,
                    -0.320516973733902,
                    0.2708964943885803,
                    0.2252483069896698,
                    -0.30401772260665894,
                    0.2111225426197052,
                    0.405138224363327,
                    0.14309459924697876,
                    -0.15266931056976318,
                    -0.1391555666923523,
                    -0.06937506794929504,
                    0.4347245693206787,
                    -0.6765874028205872,
                    0.4364396035671234,
                    -0.1439586728811264,
                    -0.330218106508255,
                    -0.38184618949890137,
                    0.472507119178772,
                    -0.14240500330924988,
                    -0.6415256261825562,
                    -0.46631577610969543,
                    -0.3544917702674866,
                    0.20134669542312622,
                    -0.6701548099517822,
                    -0.30022114515304565,
                    0.34543487429618835,
                    0.021300654858350754,
                    -0.300162672996521,
                    0.08359549194574356,
                    0.22957134246826172,
                    0.10745182633399963,
                    -0.3151223361492157,
                    -0.18129155039787292,
                    -0.21107171475887299,
                    0.3500397205352783,
                    -0.6355143785476685,
                    0.3154850900173187,
                    -0.1434948444366455,
                    0.19391007721424103,
                    -0.3311728239059448,
                    0.22299824655056,
                    -0.13010744750499725,
                    -0.08142204582691193,
                    -0.003071800572797656,
                    0.20806379616260529,
                    0.13105544447898865,
                    0.6115212440490723,
                    -0.05368323251605034,
                    0.14234910905361176,
                    0.15633167326450348,
                    0.007598326541483402,
                    -0.19142980873584747,
                    -0.1319364309310913,
                    0.17255760729312897,
                    -0.14756830036640167,
                    -0.35945796966552734,
                    -0.2566734552383423,
                    0.04788586497306824,
                    -0.1796630322933197,
                    -0.2071046382188797,
                    0.0930362343788147,
                    -0.18281050026416779,
                    0.06132321432232857,
                    0.42497268319129944,
                    0.3102211058139801,
                    -0.34064871072769165,
                    -0.07616747915744781,
                    0.2533917725086212,
                    0.03310327231884003,
                    0.05545374006032944,
                    -0.04333242028951645,
                    0.27150169014930725,
                    -0.13570834696292877,
                    -0.2228720337152481,
                    0.2747860848903656,
                    -0.1693543642759323,
                    -0.17461296916007996,
                    -0.16605398058891296,
                    0.40494832396507263,
                    -0.08580508083105087,
                    0.4011872708797455,
                    -0.1740860939025879,
                    -0.10393712669610977,
                    -0.8584681153297424,
                    -0.2561209201812744,
                    0.291912317276001,
                    -0.28773394227027893,
                    -0.37069520354270935,
                    -0.3037443459033966,
                    -0.0546131506562233,
                    0.4183732867240906,
                    0.1530008316040039,
                    0.1780438870191574,
                    -0.337599515914917,
                    0.2514627277851105,
                    -0.1966797113418579,
                    -0.014960314147174358,
                    -0.4926590025424957,
                    0.4934448003768921,
                    -0.2022872269153595,
                    -0.16022080183029175,
                    -0.1646847277879715,
                    0.22021205723285675,
                    -0.0701436847448349,
                    0.26634418964385986,
                    -0.1282155066728592,
                    0.11993912607431412,
                    -0.17461137473583221,
                    0.08971663564443588,
                    -0.007634222507476807,
                    -0.06638137996196747,
                    0.08198444545269012,
                    0.10795046389102936,
                    0.2414250671863556,
                    0.17917940020561218,
                    -0.08249030262231827,
                    0.11961188167333603,
                    -0.5903847217559814,
                    -0.3495084047317505,
                    -0.0389147587120533,
                    -0.1943056583404541,
                    -0.007084451150149107,
                    -0.10251647233963013,
                    -0.1441151648759842,
                    0.046553947031497955,
                    0.28005871176719666,
                    -0.19212564826011658,
                    -0.2199113816022873,
                    -0.2871280014514923,
                    -0.05725158005952835,
                    0.4197670817375183,
                    -0.24406711757183075,
                    -0.15272864699363708,
                    -0.2439812421798706,
                    0.1174589991569519,
                    0.10771965980529785,
                    -0.009568317793309689,
                    -0.14343173801898956,
                    0.21258802711963654,
                    0.39156386256217957,
                    -0.004193753004074097,
                    -0.2243194580078125,
                    0.29322049021720886,
                    0.5431634783744812,
                    0.10258862376213074,
                    0.5308252573013306,
                    -0.08411452919244766,
                    -0.026897892355918884,
                    -0.006665429100394249,
                    -0.033359378576278687,
                    -0.08433691412210464,
                    0.08072253316640854,
                    0.22137980163097382,
                    0.023147091269493103,
                    0.23293960094451904,
                    -0.5017114877700806,
                    0.06471186876296997,
                    -0.01774427853524685,
                    -0.3326575756072998,
                    -0.02460259199142456,
                    0.08657528460025787,
                    0.06664463877677917,
                    -0.06256276369094849,
                    -0.5966796875,
                    -0.3275448679924011,
                    -0.27894434332847595,
                    0.1869148164987564,
                    -0.14917950332164764,
                    0.379876047372818,
                    0.07821040600538254,
                    -0.10463593155145645,
                    0.058188408613204956,
                    -0.1360895037651062,
                    -0.302003413438797,
                    -0.24441443383693695,
                    -0.10848960280418396,
                    -0.08419983834028244,
                    -0.4758937358856201,
                    -0.010854613967239857,
                    0.2539350688457489,
                    0.06166457384824753,
                    0.25387275218963623,
                    -0.11420419067144394,
                    -0.3983200490474701,
                    -0.33515164256095886,
                    0.3364051580429077,
                    -0.10050571709871292,
                    0.06051355227828026,
                    -0.2098645567893982,
                    -0.047608211636543274,
                    0.2098698616027832,
                    0.17583255469799042,
                    -0.04798766225576401,
                    0.365622878074646,
                    0.22001329064369202,
                    -0.14397189021110535,
                    -0.4583844244480133,
                    0.05791798233985901,
                    -0.2715517282485962,
                    0.10253874957561493,
                    0.14080576598644257,
                    -0.29796090722084045,
                    -0.1775418370962143,
                    -0.19504208862781525,
                    -0.1818947046995163,
                    0.09806772321462631,
                    -0.037821315228939056,
                    0.03816065937280655,
                    0.4867461323738098,
                    0.011850050650537014,
                    0.15500234067440033,
                    -0.2024633288383484,
                    -0.36877816915512085,
                    -0.22427771985530853,
                    0.306011438369751,
                    -0.08598289638757706,
                    0.07647818326950073,
                    -0.13534484803676605,
                    0.014736476354300976,
                    0.029403353109955788,
                    0.21010130643844604,
                    -0.01283392496407032,
                    0.08821912854909897,
                    -0.19711178541183472,
                    0.14249639213085175,
                    -0.17781494557857513,
                    -0.41020259261131287,
                    0.2063719779253006,
                    0.18396727740764618,
                    -0.24200519919395447,
                    0.26670584082603455,
                    -0.11933276802301407,
                    -0.1486321985721588,
                    -0.16151916980743408,
                    -0.4180189073085785,
                    -0.01822534389793873,
                    0.7341123819351196,
                    0.09473622590303421,
                    -0.09742729365825653,
                    -0.21628467738628387,
                    -0.30415216088294983,
                    0.12790721654891968,
                    0.5855065584182739,
                    0.02885400876402855,
                    0.08193717151880264,
                    0.040177199989557266,
                    -0.1607934534549713,
                    -0.2698148787021637,
                    0.09452526271343231,
                    -0.3119531571865082,
                    -0.3044813275337219,
                    -0.44297510385513306,
                    0.23505903780460358,
                    0.10006546974182129,
                    -0.33577245473861694,
                    0.15439657866954803,
                    0.05617425963282585,
                    -0.1893109530210495,
                    0.7429432272911072,
                    0.2865222990512848,
                    -0.1798531711101532,
                    -0.05047650262713432,
                    -0.16066862642765045,
                    0.020284339785575867,
                    0.27135828137397766,
                    -0.18537989258766174,
                    0.2508406341075897,
                    0.05621229484677315,
                    0.26868104934692383,
                    0.08485407382249832,
                    0.6717365384101868,
                    0.31276172399520874,
                    -0.02017577923834324,
                    0.061668459326028824,
                    -0.1271098256111145,
                    -0.15517571568489075,
                    -0.4125220775604248,
                    -0.018262160941958427,
                    -0.171271413564682,
                    0.1732863038778305,
                    0.43712911009788513,
                    0.24205905199050903,
                    0.1809936761856079,
                    0.05767695978283882,
                    0.2209407091140747,
                    -0.003026355290785432,
                    0.26401394605636597,
                    0.13918490707874298,
                    -0.3610483407974243,
                    0.47600415349006653,
                    0.1639607548713684,
                    -0.1351509541273117,
                    -0.2722843289375305,
                    0.1343248039484024,
                    0.1974543333053589,
                    -0.05565410479903221,
                    0.04419408738613129,
                    0.12464811652898788,
                    0.05307069048285484,
                    0.12173228710889816,
                    0.03496785834431648,
                    0.10711798071861267,
                    -0.42076125741004944,
                    -0.024361206218600273,
                    -0.05633704736828804,
                    -0.020897481590509415,
                    0.1814114898443222,
                    0.2518661618232727,
                    -0.15533196926116943,
                    0.0008584715542383492,
                    -0.3195332884788513,
                    0.07180138677358627,
                    0.09412913769483566,
                    0.011544770561158657,
                    0.18242673575878143,
                    -0.025525987148284912,
                    0.25699225068092346,
                    -0.2995452284812927,
                    -0.38213154673576355,
                    -0.2009299248456955,
                    -0.006236872170120478,
                    0.03828088194131851,
                    0.09471499174833298,
                    0.13537520170211792,
                    -0.018957151100039482,
                    0.12048815190792084,
                    -0.622406005859375,
                    -0.2704559564590454,
                    0.13707637786865234,
                    0.12785282731056213,
                    -0.11665622889995575,
                    -0.22663439810276031,
                    -0.15143157541751862,
                    -0.276006817817688,
                    -0.13654418289661407,
                    -0.11383120715618134,
                    -0.1304892748594284,
                    -0.18050609529018402,
                    0.027922680601477623,
                    0.3089252710342407,
                    -0.1483638733625412,
                    0.26655974984169006,
                    0.15879599750041962,
                    -0.18304505944252014,
                    0.29912543296813965,
                    0.13505326211452484,
                    0.5182251334190369,
                    -0.05535108968615532,
                    -0.25318387150764465,
                    -0.21101956069469452,
                    -0.07868572324514389,
                    0.17628026008605957,
                    0.23281298577785492,
                    0.06650198996067047,
                    0.32735466957092285,
                    0.13482296466827393,
                    -0.212172731757164,
                    -0.11895927786827087,
                    -0.3392448425292969,
                    0.10310105979442596,
                    -0.4340207576751709,
                    0.12483305484056473,
                    0.20638924837112427,
                    0.16922415792942047,
                    0.2913409173488617,
                    0.048767656087875366,
                    0.037285685539245605,
                    -0.39493563771247864,
                    -0.36548447608947754,
                    0.2514895498752594,
                    -0.2285517156124115,
                    -0.20632676780223846,
                    0.558261513710022,
                    0.027741404250264168,
                    -0.3346431255340576,
                    0.1356630176305771,
                    0.27456024289131165,
                    0.0613764151930809,
                    -0.1788741648197174,
                    -0.03022126480937004,
                    -0.32445672154426575,
                    -0.08381035923957825,
                    0.21695558726787567,
                    0.4365893304347992,
                    -0.38611316680908203,
                    -0.3842463791370392,
                    -0.0027733759488910437,
                    0.3910776972770691,
                    -0.17081746459007263,
                    0.07512743771076202,
                    0.186859130859375,
                    -0.08931814879179001,
                    0.35307204723358154,
                    0.014369609765708447,
                    -0.06055711954832077,
                    0.13812607526779175,
                    -0.11007323116064072,
                    0.13442514836788177,
                    -0.2088298350572586,
                    -0.0019415946444496512,
                    0.33755216002464294,
                    -0.3884008526802063,
                    0.19657260179519653,
                    0.1408294141292572,
                    -0.1336454600095749,
                    0.08090092986822128,
                ],
            },
            "family_document_ref": "id:doc_search:family_document::CCLW.executive.10014.4470",
            "text_block": "800 ha land - decontaminate d; 1588 locations \u2013 decontaminate d",
            "concepts": [
                # Has the parent concepts missing
                {
                    "name": "sectors",
                    "id": "concept_0_0",
                    "start": 1,
                    "end": 18,
                    "model": "sectors_model",
                    "timestamp": "2024-09-26T16:15:39.817896",
                },
                {
                    "name": "environment",
                    "id": "concept_0_0",
                    "start": 13,
                    "end": 34,
                    "model": "environment_model",
                    "timestamp": "2024-09-26T16:15:39.817896",
                    #  Has the parent concepts present
                    "parent_concepts": [
                        {"id": "Q0", "name": "Q0-name"},
                        {"id": "Q1", "name": "Q1-name"},
                    ],
                    "parent_concept_ids_flat": "Q0,Q1,",
                },
            ],
        },
    }

    assert Passage.from_vespa_response(response_hit=response_hit) == Passage(
        family_name=None,
        family_description=None,
        family_source=None,
        family_import_id=None,
        family_slug=None,
        family_category=None,
        family_publication_ts=None,
        family_geography=None,
        family_geographies=[],
        document_import_id=None,
        document_slug=None,
        document_languages=[],
        document_content_type=None,
        document_cdn_object=None,
        document_source_url=None,
        corpus_type_name=None,
        corpus_import_id=None,
        metadata=None,
        concepts=[
            Passage.Concept(
                id="concept_0_0",
                name="sectors",
                parent_concepts=None,
                parent_concept_ids_flat=None,
                model="sectors_model",
                end=18,
                start=1,
                timestamp=datetime(2024, 9, 26, 16, 15, 39, 817896),
            ),
            Passage.Concept(
                id="concept_0_0",
                name="environment",
                parent_concepts=[
                    {"id": "Q0", "name": "Q0-name"},
                    {"id": "Q1", "name": "Q1-name"},
                ],
                parent_concept_ids_flat="Q0,Q1,",
                model="environment_model",
                end=34,
                start=13,
                timestamp=datetime(2024, 9, 26, 16, 15, 39, 817896),
            ),
        ],
        relevance=None,
        rank_features=None,
        concept_counts=None,
        text_block="800 ha land - decontaminate d; 1588 locations – decontaminate d",
        text_block_id="1457",
        text_block_type="BlockType.TABLE_CELL",
        text_block_page=83,
        text_block_coords=[
            (529.1136, 261.1368),
            (613.6128, 261.1368),
            (613.6128, 356.8968),
            (529.1136, 356.8968),
        ],
    )
